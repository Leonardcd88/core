<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/google-apis/google-jsapi.html">

<polymer-element name="state-timeline" attributes="stateHistory">
  <template>
    <style>
    :host {
      display: block;
    }
    </style>

    <google-jsapi on-api-load="{{googleApiLoaded}}"></google-jsapi>
    <div id="timeline" style='width: 100%; height: auto;'></div>

  </template>
  <script>
  Polymer({
    apiLoaded: false,
    stateHistory: null,

    googleApiLoaded: function() {
      google.load("visualization", "1", {
        packages: ["timeline"],
        callback: function() {
          this.apiLoaded = true;
          this.drawChart();
        }.bind(this)
      });
    },

    stateHistoryChanged: function() {
      this.drawChart();
    },

    drawChart: function() {
      if (!this.apiLoaded || !this.stateHistory) {
        return;
      }

      var container = this.$.timeline;
      var chart = new google.visualization.Timeline(container);
      var dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: 'string', id: 'Entity' });
      dataTable.addColumn({ type: 'string', id: 'State' });
      dataTable.addColumn({ type: 'date', id: 'Start' });
      dataTable.addColumn({ type: 'date', id: 'End' });

      var stateTimeToDate = function(time) {
        if (!time) return new Date();

        return window.hass.util.parseTime(time).toDate();
      };

      var addRow = function(baseState, state, tillState) {
        tillState = tillState || {};

        dataTable.addRow([
          baseState.entityDisplay, state.state,
          stateTimeToDate(state.last_changed),
          stateTimeToDate(tillState.last_changed)]);
      };

      // people can pass in history of 1 entityId or a collection.
      var stateHistory = _.isArray(this.stateHistory[0]) ?
                           this.stateHistory : [this.stateHistory];

      // stateHistory is a list of lists of sorted state objects
      stateHistory.forEach(function(stateInfo) {
        if(stateInfo.length === 0) return;

        var baseState = new window.hass.stateModel(stateInfo[0]);

        var prevRow = null;

        stateInfo.forEach(function(state) {
          if (prevRow !== null && state.state !== prevRow.state) {
            addRow(baseState, prevRow, state);
            prevRow = state;
          } else if (prevRow === null) {
            prevRow = state;
          }
        });

        addRow(baseState, prevRow, null);
      }.bind(this));

      chart.draw(dataTable, {
        height: 55 + stateHistory.length * 42,

        // interactive properties require CSS, the JS api puts it on the document
        // instead of inside our Shadow DOM.
        enableInteractivity: false,

        timeline: {
          showRowLabels: stateHistory.length > 1
        },

        hAxis: {
          format: 'H:mm'
        },
      });
    },

  });
  </script>
</polymer-element>
