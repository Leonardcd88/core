<link rel="import" href="./bower_components/polymer/polymer.html">

<script src="./home-assistant-js/dist/homeassistant.min.js"></script>

<link rel="import" href="./dialogs/more-info-dialog.html">

<script>
  var DOMAINS_WITH_CARD = ['thermostat', 'configurator'];
  var DOMAINS_WITH_MORE_INFO = ['light', 'group', 'sun', 'configurator'];

  // Register some polymer filters

  PolymerExpressions.prototype.HATimeToDate = function(timeString) {
    if (!timeString) return;

    return window.hass.util.parseDateTime(timeString);
  };

  PolymerExpressions.prototype.HATimeStripDate = function(timeString) {
    return (timeString || "").split(' ')[0];
  };

  // Add some frontend specific helpers to the models
  Object.defineProperties(window.hass.stateModel.prototype, {
    // how to render the card for this state
    cardType: {
      get: function() {
        if(DOMAINS_WITH_CARD.indexOf(this.domain) !== -1) {
          return this.domain;
        } else if(this.canToggle) {
          return "toggle";
        } else {
          return "display";
        }
      }
    },

    // how to render the more info of this state
    moreInfoType: {
      get: function() {
        if(DOMAINS_WITH_MORE_INFO.indexOf(this.domain) !== -1) {
          return this.domain;
        } else {
          return 'default';
        }
      }
    },
  });

  var state,
      constants = window.hass.constants,
      dispatcher = window.hass.dispatcher,
      preferenceStore = window.hass.preferenceStore;

  var uiActions = window.hass.uiActions = {
    ACTION_SHOW_TOAST: constants.ACTION_SHOW_TOAST,
    ACTION_SHOW_DIALOG_MORE_INFO: 'ACTION_SHOW_DIALOG_MORE_INFO',

    showMoreInfoDialog: function(entityId) {
      dispatcher.dispatch({
        actionType: this.ACTION_SHOW_DIALOG_MORE_INFO,
        entityId: entityId,
      });
    },

    validateAuth: function(authToken) {
      window.hass.authActions.validate(authToken, preferenceStore.useStreaming());  
    },

  };
</script>

<polymer-element name="home-assistant-api" attributes="auth">
  <template>
    <more-info-dialog id="moreInfoDialog"></more-info-dialog>
  </template>
  <script>
  Polymer({
    ready: function() {
      dispatcher.register(function(payload) {
        switch (payload.actionType) {
          case uiActions.ACTION_SHOW_DIALOG_MORE_INFO:
            this.$.moreInfoDialog.show(payload.entityId);
            break;
        }  
      }.bind(this));

      // if auth was given, tell the backend
      if(this.auth) {
        window.hass.uiActions.validateAuth(this.auth);    
      }
    },
  });
  </script>
</polymer-element>
