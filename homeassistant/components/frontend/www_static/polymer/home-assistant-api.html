<link rel="import" href="./bower_components/paper-toast/paper-toast.html">

<link rel="import" href="./dialogs/event-fire-dialog.html">
<link rel="import" href="./dialogs/service-call-dialog.html">
<link rel="import" href="./dialogs/state-set-dialog.html">
<link rel="import" href="./dialogs/more-info-dialog.html">
<link rel="import" href="./dialogs/history-dialog.html">

<script src="./home-assistant-js/dist/homeassistant.min.js"></script>

<script>
  // Register some polymer filters
  PolymerExpressions.prototype.relativeHATime = function(timeString) {
    return window.hass.util.relativeTime(timeString);
  };
  PolymerExpressions.prototype.HATimeStripDate = function(timeString) {
    return (timeString || "").split(' ')[0];
  };
</script>

<polymer-element name="home-assistant-api" attributes="auth">
  <template>
    <paper-toast id="toast" role="alert" text=""></paper-toast>
    <event-fire-dialog id="eventDialog"></event-fire-dialog>
    <service-call-dialog id="serviceDialog"></service-call-dialog>
    <state-set-dialog id="stateSetDialog"></state-set-dialog>
    <more-info-dialog id="moreInfoDialog"></more-info-dialog>
    <history-dialog id="historyDialog"></history-dialog>
  </template>
  <script>
  Polymer({
    ready: function() {
      var state,
          actions = window.hass.actions,
          dispatcher = window.hass.dispatcher;

      var uiActions = window.hass.uiActions = {
        ACTION_SHOW_TOAST: actions.ACTION_SHOW_TOAST,
        ACTION_SHOW_DIALOG_CALL_SERVICE: 'ACTION_SHOW_DIALOG_CALL_SERVICE',
        ACTION_SHOW_DIALOG_FIRE_EVENT: 'ACTION_SHOW_DIALOG_FIRE_EVENT',
        ACTION_SHOW_DIALOG_SET_STATE: 'ACTION_SHOW_DIALOG_SET_STATE',
        ACTION_SHOW_DIALOG_HISTORY: 'ACTION_SHOW_DIALOG_HISTORY',
        ACTION_SHOW_DIALOG_MORE_INFO: 'ACTION_SHOW_DIALOG_MORE_INFO',

        showMoreInfoDialog: function(entityId) {
          dispatcher.dispatch({
            actionType: this.ACTION_SHOW_DIALOG_MORE_INFO,
            entityId: entityId,
          });
        },

        showSetStateDialog: function(entityId) {
          dispatcher.dispatch({
            actionType: this.ACTION_SHOW_DIALOG_SET_STATE,
            entityId: entityId
          });
        },

        showFireEventDialog: function() {
          dispatcher.dispatch({
            actionType: this.ACTION_SHOW_DIALOG_FIRE_EVENT,
          });
        },

        showCallServiceDialog: function() {
          dispatcher.dispatch({
            actionType: this.ACTION_SHOW_DIALOG_CALL_SERVICE,
          });
        },

        showHistoryDialog: function() {
          dispatcher.dispatch({
            actionType: this.ACTION_SHOW_DIALOG_HISTORY,
          });
        },

      };

      var getState = function(entityId) {
        return window.hass.stateStore.get(entityId);
      };

      dispatcher.register(function(payload) {
        switch (payload.actionType) {
          case actions.ACTION_SHOW_TOAST:
            this.$.toast.text = payload.message;
            this.$.toast.show();
            break;

          case uiActions.ACTION_SHOW_DIALOG_HISTORY:
            this.$.historyDialog.show();
            break;

          case uiActions.ACTION_SHOW_DIALOG_MORE_INFO:
            state = getState(payload.entityId);

            this.$.moreInfoDialog.show(state);
            break;

          case uiActions.ACTION_SHOW_DIALOG_SET_STATE:
            if (payload.entityId) {
              state = getState(payload.entityId);

              this.$.stateSetDialog.show(
                state.entity_id, state.state, state.attributes);
            } else {
              this.$.stateSetDialog.show("", "");              
            }
            break;

          case uiActions.ACTION_SHOW_DIALOG_FIRE_EVENT:
            this.$.eventDialog.show();
            break;

          case uiActions.ACTION_SHOW_DIALOG_CALL_SERVICE:
            this.$.serviceDialog.show();
            break;

        }  
      }.bind(this));

      // if auth was given, tell the backend
      if(this.auth) {
        window.hass.authActions.validate(this.auth);
      }
    },

  });
  </script>
</polymer-element>
