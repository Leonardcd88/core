<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="./partial-base.html">

<link rel="import" href="../components/ha-logbook.html">
<link rel="import" href="../components/loading-box.html">

<dom-module id="partial-logbook">
  <style>
  .selected-date-container {
    padding: 0 16px;
  }

  paper-input {
    max-width: 200px;
  }
  </style>
  <template>
    <partial-base narrow="[[narrow]]">
      <span header-title>Logbook</span>

      <paper-icon-button icon="refresh" header-buttons
        on-click="handleRefresh"></paper-icon-button>

      <div>
        <div class='selected-date-container'>
          <paper-input label='Showing entries for' on-click='handleShowDatePicker'
            value='[[computeDateCaption(selectedDate)]]'></paper-input>

          <loading-box hidden$='[[!isLoading]]'>Loading logbook entries</loading-box>
        </div>
        <ha-logbook entries="[[entries]]" hidden$='[[isLoading]]'></ha-logbook>
      </div>
    </partial-base>
  </template>
</dom-module>

<script>
(function() {
  var storeListenerMixIn = window.hass.storeListenerMixIn;
  var logbookActions = window.hass.logbookActions;
  var logbookStore = window.hass.logbookStore;
  var uiActions = window.hass.uiActions;

  function date_to_str(date) {
    return date.getFullYear() + '-' + (date.getMonth()+1) + '-' + date.getDate();
  }

  Polymer({
    is: 'partial-logbook',

    behaviors: [StoreListenerBehavior],

    properties: {
      narrow: {
        type: Boolean,
        value: false,
      },

      selectedDate: {
        type: String,
        value: null,
        observer: 'fetchIfNeeded',
      },

      isLoading: {
        type: Boolean,
        value: true,
      },

      entries: {
        type: Array,
        value: null,
      },
    },

    logbookStoreChanged: function() {
      this.isLoading = this.fetchIfNeeded();
      var entries = logbookStore.all.toArray();
      this.entries = entries.length > 0 ? entries : false;
    },

    computeDateCaption: function(selectedDate) {
      return selectedDate || 'today';
    },

    fetchIfNeeded: function() {
      if (logbookStore.shouldFetch(this.selectedDate)) {
        this.isLoading = true;
        logbookActions.fetch(this.selectedDate);
        return true;
      }
      return false;
    },

    handleShowDatePicker: function() {
      uiActions.showDatePicker(function(selectedDate) {
        this.selectedDate = date_to_str(selectedDate);
      }.bind(this), this.selectedDate);
    },

    handleRefresh: function() {
      logbookActions.fetch(this.selectedDate);
    },
  });
})();
</script>
